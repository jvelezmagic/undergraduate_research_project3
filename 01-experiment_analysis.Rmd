---
#########################################
# options for knitting a single chapter #
#########################################
output:
  bookdown::pdf_document2:
    template: templates/brief_template.tex
    citation_package: biblatex
  bookdown::html_document2: default
  bookdown::word_document2: default
documentclass: book
#bibliography: [bibliography/references.bib, bibliography/additional-references.bib]
---

# Experiment analysis

\minitoc <!-- this will include a mini table of contents-->

```{r 01-setup, echo=FALSE, message=FALSE}
include_image <- function(url_web, url_latex) {
  
  url_file <- ifelse(
    test = knitr::is_latex_output(),
    yes = url_latex,
    no = url_web
  )
  
  linguisticsdown::include_graphics2(path = url_file)
}

custom_include <- function(url_base, file_name, web_type = ".png", latex_type = ".pdf") {
  include_image(
    url_web = paste0(url_base, "figure-html/", file_name, web_type),
    url_latex = paste0(url_base, "figure-latex/", file_name, latex_type)
  )
}

main_url <- "https://raw.githubusercontent.com/jvelezmagic/CellFilamentationAnalysis/main/_bookdown_files/"
include_cells_image <- purrr::partial(
  .f = custom_include,
  url_base = paste0(main_url, "03-jvelezmagic-cell-eda_files/")
)

include_tracks_image <- purrr::partial(
  .f = custom_include,
  url_base = paste0(main_url, "04-jvelezmagic-cell-time-eda_files/")
)

knitr::opts_chunk$set(
  fig.pos = "H",
  out.width = "100%",
  echo = FALSE,
  message = FALSE
)
```


## Introduction

## Experiment design

## Exploratory Data Analysis

### General preprocessing of data

The processing of the raw data consisted mainly of creating two levels of observation for the cells of both chromosomal strains and multicopy plasmids. The first level is at a cell granularity, that is, point properties. The second level consists of the cells over time, thus observing properties at the population level. We did this because it would allow us to understand what factors are affecting filamentation and why.

We decided to normalize the fluorescence values of DS-Red and GFP for both experiments based on the values observed before the start of the experiment. It allowed us to have a basis to work with and compare the expressions between cells. In the case of DS-Red, we also applied a logarithmic transformation to observe subtle changes that would allow us to dig deeper.

Ultimately, we decided to classify cells into four fundamental groups based on whether the cell was filamented and survived (see \@ref(fig:03-cells-distribution-across-experiments)). We define a _filamented cell_ as a cell that is more than two standard deviations from the mean concerning the lengths observed before antibiotic entry into the system []. On the other hand, although there are multiple ways to define death in a cell context [], we decided to consider a _cell dead or missing_ when we stopped having information about it, either because of its fluorescence levels or because it left the field of experimental tracking. Therefore, a _surviving cell_ is one that existed before and after the exposure to the antibiotic.

### Cells level

(ref:03-cells-distribution-across-experiments-1-scap) Cell classification and its distribution across experiments.

(ref:3-cells-distribution-across-experiments-1-cap) **Cell classification and its distribution across experiments.** We define a _filamented cell_ as a cell whose length exceeded two standard deviations from the mean at any time during the experiment. A _surviving cell_ is a cell that existed before and after exposure to the antibiotic. We removed from the analysis those cells that died before or were born after the exposure of the experiment. Therefore, we delimit the effect caused by the exposure to the antibiotic.

```{r 03-cells-distribution-across-experiments, fig.cap='(ref:3-cells-distribution-across-experiments-1-cap)', fig.scap='(ref:03-cells-distribution-across-experiments-1-scap)'}
include_cells_image("03-cells-distribution-across-experiments-1")
```

(ref:03-cells-life-time-classes-distribution-1) **Cells life time classes distribution.**

```{r 03-cells-life-time-classes-distribution-1, fig.cap='(ref:03-cells-life-time-classes-distribution-1)'}
include_cells_image("03-cells-life-time-classes-distribution-1")
```

(ref:03-division-number-divisions-1) **Cell's number of divisions.**

```{r 03-division-number-divisions-1, fig.cap='(ref:03-division-number-divisions-1)'}
include_cells_image("03-division-number-divisions-1")
```

(ref:03-division-time-since-last-division-1) **Time since last division**

```{r 03-division-time-since-last-division-1, fig.cap='(ref:03-division-time-since-last-division-1)'}
include_cells_image("03-division-time-since-last-division-1")
```

(ref:03-focus-just-in-initial-values-1) **Experiment initial values**

```{r 03-focus-just-in-initial-values-1, fig.cap='(ref:03-focus-just-in-initial-values-1)'}
include_cells_image("03-focus-just-in-initial-values-1")
```

(ref:03-metric-differences-1) **Experiment initial values differences.**

```{r 03-metric-differences-1, fig.cap='(ref:03-metric-differences-1)'}
include_cells_image("03-metric-differences-1")
```

(ref:03-see-datasets-individualy-pca-chromosome-points-in-new-coordinates-1) **Chromosome PCA.**

```{r 03-see-datasets-individualy-pca-chromosome-points-in-new-coordinates-1, fig.cap='(ref:03-see-datasets-individualy-pca-chromosome-points-in-new-coordinates-1)'}
include_cells_image("03-see-datasets-individualy-pca-chromosome-points-in-new-coordinates-1")
```

(ref:03-see-datasets-individualy-pca-chromosome-variable-contribution-1) **Chromosome PCA variables contribution.**

```{r 03-see-datasets-individualy-pca-chromosome-variable-contribution-1, fig.cap='(ref:03-see-datasets-individualy-pca-chromosome-variable-contribution-1)'}
include_cells_image("03-see-datasets-individualy-pca-chromosome-variable-contribution-1")
```

(ref:03-see-datasets-individualy-pca-plasmid-points-in-new-coordinates-1) **Plasmid PCA**

```{r 03-see-datasets-individualy-pca-plasmid-points-in-new-coordinates-1, fig.cap='(ref:03-see-datasets-individualy-pca-plasmid-points-in-new-coordinates-1)'}
include_cells_image("03-see-datasets-individualy-pca-plasmid-points-in-new-coordinates-1")
```

(ref:03-see-datasets-individualy-pca-plasmid-variable-contribution-1) **Plasmid PCA variables contribution.**

```{r 03-see-datasets-individualy-pca-plasmid-variable-contribution-1, fig.cap='(ref:03-see-datasets-individualy-pca-plasmid-variable-contribution-1)'}
include_cells_image("03-see-datasets-individualy-pca-plasmid-variable-contribution-1")
```

(ref:03-see-datasets-individualy-umap-chromosome-points-in-new-coordinates-1) **UMAP of Chromosome experiment.**

```{r 03-see-datasets-individualy-umap-chromosome-points-in-new-coordinates-1, fig.cap='(ref:03-see-datasets-individualy-umap-chromosome-points-in-new-coordinates-1)'}
include_cells_image("03-see-datasets-individualy-umap-chromosome-points-in-new-coordinates-1")
```

(ref:3-see-datasets-individualy-umap-plasmid-points-in-new-coordinates-1) **UMAP of Plasmid experiment.**

```{r 3-see-datasets-individualy-umap-plasmid-points-in-new-coordinates-1, fig.cap='(ref:3-see-datasets-individualy-umap-plasmid-points-in-new-coordinates-1)'}
include_cells_image("03-see-datasets-individualy-umap-plasmid-points-in-new-coordinates-1")
```

(ref:03-temporal-metric-distribution-ds-red-1) **DS-red temporal distribution.**

```{r 03-temporal-metric-distribution-ds-red-1, fig.cap='(ref:03-temporal-metric-distribution-ds-red-1)'}
include_cells_image("03-temporal-metric-distribution-ds-red-1")
```

(ref:03-temporal-metric-distribution-gfp-1) **GFP temporal distribution.**

```{r 03-temporal-metric-distribution-gfp-1, fig.cap='(ref:03-temporal-metric-distribution-gfp-1)'}
include_cells_image("03-temporal-metric-distribution-gfp-1")
```

(ref:03-temporal-metric-distribution-length-1) **Length temporal distribution.**

```{r 03-temporal-metric-distribution-length-1, fig.cap='(ref:03-temporal-metric-distribution-length-1)'}
include_cells_image("03-temporal-metric-distribution-length-1")
```

(ref:03-time-to-filamentation-all-1) **Time to filamentation without filters.**

```{r 03-time-to-filamentation-all-1, fig.cap='(ref:03-time-to-filamentation-all-1)'}
include_cells_image("03-time-to-filamentation-all-1")
```

(ref:03-time-to-filamentation-filamented-once-experiment-start-1) **Time to filamentation filtered.**

```{r 03-time-to-filamentation-filamented-once-experiment-start-1, fig.cap='(ref:03-time-to-filamentation-filamented-once-experiment-start-1)'}
include_cells_image("03-time-to-filamentation-filamented-once-experiment-start-1")
```

(ref:03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-diff-values-1) **Experiment initial values differences with time.**

```{r 03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-diff-values-1, fig.cap='(ref:03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-diff-values-1)'}
include_cells_image("03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-diff-values-1")
```

(ref:03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-initial-values-1) **Experiment initial values with time.**

```{r 03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-initial-values-1, fig.cap='(ref:03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-initial-values-1)'}
include_cells_image("03-time-to-filamentation-include-time-to-filamentation-in-initial-exploration-initial-values-1")
```

### Tracks level

(ref:04-metrics-over-time-1) **Population measurements over time.**

```{r 04-metrics-over-time-1, fig.cap='(ref:04-metrics-over-time-1)'}
include_tracks_image("04-metrics-over-time-1")
```

(ref:04-length-survival-probability-1) **Plasmid initial GFP survival probability.**

```{r 04-length-survival-probability-1, fig.cap='(ref:04-length-survival-probability-1)'}
include_tracks_image("04-length-survival-probability-1")
```

(ref:04-gfp-survival-probability-1) **Plasmid initial length survival probability.**

```{r 04-gfp-survival-probability-1, fig.cap='(ref:04-gfp-survival-probability-1)'}
include_tracks_image("04-gfp-survival-probability-1")
```

(ref:04-cell-status-over-time-status-without-dead-1) **Population status over time without dead.**

```{r 04-cell-status-over-time-status-without-dead-1, fig.cap='(ref:04-cell-status-over-time-status-without-dead-1)'}
include_tracks_image("04-cell-status-over-time-status-without-dead-1")
```

(ref:04-cell-status-over-time-status-with-dead-1) **Population status over time with dead.**

```{r 04-cell-status-over-time-status-with-dead-1, fig.cap='(ref:04-cell-status-over-time-status-with-dead-1)'}
include_tracks_image("04-cell-status-over-time-status-with-dead-1")
```

(ref:04-cell-status-over-time-proportion-living-cells-by-gfp-row-1) **Population survivals binned by initial GFP over time.**

```{r 04-cell-status-over-time-proportion-living-cells-by-gfp-row-1, fig.cap='(ref:04-cell-status-over-time-proportion-living-cells-by-gfp-row-1)'}
include_tracks_image("04-cell-status-over-time-proportion-living-cells-by-gfp-row-1")
```

(ref:04-cell-status-over-time-proportion-living-cells-by-gfp-point-1) **Normalized population survivals binned by initial GFP over time.**

```{r 04-cell-status-over-time-proportion-living-cells-by-gfp-point-1, fig.cap='(ref:04-cell-status-over-time-proportion-living-cells-by-gfp-point-1)'}
include_tracks_image("04-cell-status-over-time-proportion-living-cells-by-gfp-point-1")
```

## Discussion
